╔══════════════════════════════════════════════════════════════════════╗
║  📋 SQL CORRECTO - SIN ERRORES DE SINTAXIS                          ║
╚══════════════════════════════════════════════════════════════════════╝

❌ ERROR DETECTADO:
═════════════════════════════════════════════════════════════════════

Error: syntax error at or near "S"
Causa: Se copió mal el SQL (incluyendo caracteres extra)


✅ SOLUCIÓN: COPIAR SQL LIMPIO
═════════════════════════════════════════════════════════════════════

Archivo: /sql/trigger-simple.sql

🎯 INSTRUCCIONES:

1. Abre Supabase SQL Editor
2. Borra TODO lo que esté en el editor
3. Copia EXACTAMENTE este SQL:


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
COPIA DESDE ESTA LÍNEA ⬇️
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

DROP TRIGGER IF EXISTS create_profile_after_user_insert ON auth.users;
DROP FUNCTION IF EXISTS public.ensure_profile_exists() CASCADE;

CREATE OR REPLACE FUNCTION public.ensure_profile_exists()
RETURNS TRIGGER AS $$
DECLARE
  generated_username TEXT;
BEGIN
  generated_username := COALESCE(
    NEW.raw_user_meta_data->>'username',
    LOWER(REPLACE(SPLIT_PART(NEW.email, '@', 1), '.', '_'))
  );
  
  INSERT INTO public.profiles (
    id,
    email,
    username,
    avatar_url,
    bio,
    is_admin,
    xp_points,
    current_level,
    created_at,
    updated_at
  ) VALUES (
    NEW.id,
    NEW.email,
    generated_username,
    'https://ui-avatars.com/api/?name=' || COALESCE(NEW.raw_user_meta_data->>'name', 'User') || '&background=D4AF37&color=0B0C0F&bold=true',
    NULL,
    FALSE,
    0,
    1,
    NOW(),
    NOW()
  )
  ON CONFLICT (id) DO NOTHING;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER create_profile_after_user_insert
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION public.ensure_profile_exists();

SELECT tgname, tgenabled FROM pg_trigger WHERE tgname = 'create_profile_after_user_insert';

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
COPIA HASTA ESTA LÍNEA ⬆️
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


4. Click en "RUN" o Ctrl+Enter


✅ RESULTADO ESPERADO:
═════════════════════════════════════════════════════════════════════

Primera query (DROP):
  "Success. No rows returned" ✅

Segunda query (CREATE FUNCTION):
  "Success. No rows returned" ✅

Tercera query (CREATE TRIGGER):
  "Success. No rows returned" ✅

Cuarta query (SELECT):
  ┌─────────────────────────────────┬────────────┐
  │ tgname                          │ tgenabled  │
  ├─────────────────────────────────┼────────────┤
  │ create_profile_after_user_insert│ O          │
  └─────────────────────────────────┴────────────┘

  O = enabled (trigger activo) ✅


⚠️ SI SIGUE DANDO ERROR:
═════════════════════════════════════════════════════════════════════

1. Asegúrate de NO copiar los guiones de arriba/abajo
2. Asegúrate de NO tener espacios extra al inicio
3. Copia desde DROP TRIGGER hasta el último SELECT
4. Verifica que no haya caracteres raros (encoding UTF-8)


📌 ALTERNATIVA: COPIAR DESDE ARCHIVO
═════════════════════════════════════════════════════════════════════

Abre el archivo: /sql/trigger-simple.sql
Selecciona TODO desde DROP TRIGGER hasta el SELECT final
Copia y pega en Supabase SQL Editor


🔍 VERIFICACIÓN MANUAL:
═════════════════════════════════════════════════════════════════════

Después de ejecutar, verifica manualmente:

SELECT 
    proname as function_name,
    prosrc as function_body
FROM pg_proc
WHERE proname = 'ensure_profile_exists';

Debe retornar 1 fila con el cuerpo de la función.


═════════════════════════════════════════════════════════════════════

Intenta de nuevo con el SQL limpio y dime el resultado! 🚀

═════════════════════════════════════════════════════════════════════
