<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test YavlAgro Integration - YavlGold</title>
  
  <!-- ThemeManager para test -->
  <script src="/assets/js/themeManager.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Courier New', monospace;
      background: #0a0a0a;
      color: #00ff00;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      color: #00ff00;
      border-bottom: 2px solid #00ff00;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    
    h2 {
      color: #ffff00;
      margin-top: 30px;
      margin-bottom: 15px;
    }
    
    .test-section {
      background: rgba(0, 255, 0, 0.05);
      border: 1px solid #00ff00;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    
    .test-item {
      background: rgba(0, 0, 0, 0.5);
      border-left: 4px solid #666;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
    }
    
    .test-item.pass {
      border-left-color: #00ff00;
      background: rgba(0, 255, 0, 0.1);
    }
    
    .test-item.fail {
      border-left-color: #ff0000;
      background: rgba(255, 0, 0, 0.1);
      color: #ff6666;
    }
    
    .test-item.warn {
      border-left-color: #ffaa00;
      background: rgba(255, 170, 0, 0.1);
      color: #ffaa00;
    }
    
    .status {
      font-weight: bold;
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      margin-right: 10px;
    }
    
    .pass .status {
      background: #00ff00;
      color: #000;
    }
    
    .fail .status {
      background: #ff0000;
      color: #fff;
    }
    
    .warn .status {
      background: #ffaa00;
      color: #000;
    }
    
    button {
      background: #00ff00;
      color: #000;
      border: none;
      padding: 12px 24px;
      font-weight: bold;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      margin: 10px 10px 10px 0;
      border-radius: 4px;
      font-size: 14px;
    }
    
    button:hover {
      background: #00cc00;
    }
    
    button:active {
      background: #009900;
    }
    
    pre {
      background: rgba(0, 0, 0, 0.7);
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      border: 1px solid #333;
      margin: 10px 0;
    }
    
    code {
      color: #ff6666;
      font-family: 'Courier New', monospace;
    }
    
    .summary {
      background: rgba(255, 255, 0, 0.1);
      border: 2px solid #ffff00;
      padding: 20px;
      margin: 30px 0;
      border-radius: 8px;
    }
    
    .summary h3 {
      color: #ffff00;
      margin-bottom: 15px;
    }
    
    .counter {
      display: inline-block;
      margin: 0 15px;
      font-size: 18px;
    }
    
    .counter.pass { color: #00ff00; }
    .counter.fail { color: #ff0000; }
    .counter.warn { color: #ffaa00; }
    
    a {
      color: #00aaff;
      text-decoration: none;
    }
    
    a:hover {
      text-decoration: underline;
    }
    
    .loading {
      color: #ffff00;
      font-size: 18px;
      text-align: center;
      padding: 40px;
    }
    
    .fix-button {
      background: #ff6600;
      color: #fff;
      margin-left: 10px;
    }
    
    .fix-button:hover {
      background: #ff8800;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ TEST: YavlAgro Integration</h1>
    <p>Este test verifica la integraci√≥n completa de YavlAgro con el sistema YavlGold</p>
    
    <button onclick="runAllTests()">‚ñ∂ Ejecutar Todos los Tests</button>
    <button onclick="location.reload()">üîÑ Recargar</button>
    
    <div id="summary" class="summary" style="display: none;">
      <h3>üìä Resumen de Tests</h3>
      <div>
        <span class="counter pass">‚úì <span id="passCount">0</span> PASS</span>
        <span class="counter fail">‚úó <span id="failCount">0</span> FAIL</span>
        <span class="counter warn">‚ö† <span id="warnCount">0</span> WARN</span>
      </div>
    </div>
    
    <div id="results"></div>
  </div>
  
  <script>
    const results = document.getElementById('results');
    const summary = document.getElementById('summary');
    let passCount = 0;
    let failCount = 0;
    let warnCount = 0;
    
    function updateSummary() {
      document.getElementById('passCount').textContent = passCount;
      document.getElementById('failCount').textContent = failCount;
      document.getElementById('warnCount').textContent = warnCount;
      summary.style.display = 'block';
    }
    
    function addTestSection(title) {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.innerHTML = `<h2>${title}</h2>`;
      results.appendChild(section);
      return section;
    }
    
    function addTestResult(section, status, message, details = '') {
      const item = document.createElement('div');
      item.className = `test-item ${status}`;
      
      let statusText = '';
      if (status === 'pass') {
        statusText = '‚úì PASS';
        passCount++;
      } else if (status === 'fail') {
        statusText = '‚úó FAIL';
        failCount++;
      } else if (status === 'warn') {
        statusText = '‚ö† WARN';
        warnCount++;
      }
      
      item.innerHTML = `
        <div><span class="status">${statusText}</span> ${message}</div>
        ${details ? `<pre>${details}</pre>` : ''}
      `;
      
      section.appendChild(item);
      updateSummary();
    }
    
    async function testFetchPage(url) {
      try {
        const response = await fetch(url);
        return {
          ok: response.ok,
          status: response.status,
          text: await response.text()
        };
      } catch (error) {
        return {
          ok: false,
          status: 0,
          error: error.message
        };
      }
    }
    
    async function runAllTests() {
      // Limpiar resultados previos
      results.innerHTML = '<div class="loading">‚è≥ Ejecutando tests...</div>';
      passCount = 0;
      failCount = 0;
      warnCount = 0;
      
      await new Promise(resolve => setTimeout(resolve, 500));
      results.innerHTML = '';
      
      // Test 1: Verificar archivos YavlAgro
      await testYavlAgroFiles();
      
      // Test 2: Verificar enlaces en Dashboard
      await testDashboardLinks();
      
      // Test 3: Verificar AuthGuard
      await testAuthGuard();
      
      // Test 4: Verificar ThemeManager
      await testThemeManager();
      
      // Test 5: Verificar Calculadora
      await testCalculadoraLinks();
      
      // Test 6: Verificar metadatos
      await testMetadata();
      
      // Scroll al resumen
      summary.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    async function testYavlAgroFiles() {
      const section = addTestSection('1Ô∏è‚É£ Archivos YavlAgro');
      
      // Test index.html
      const indexResult = await testFetchPage('/apps/agro/index.html');
      if (indexResult.ok) {
        addTestResult(section, 'pass', '/apps/agro/index.html existe y es accesible');
        
        // Verificar Supabase SDK
        if (indexResult.text.includes('supabase')) {
          addTestResult(section, 'pass', 'Supabase SDK incluido en index.html');
        } else {
          addTestResult(section, 'fail', 'Supabase SDK NO encontrado en index.html', 
            'Debe incluir: script tag de Supabase JS v2');
        }
        
        // Verificar ThemeManager
        if (indexResult.text.includes('themeManager.js') || indexResult.text.includes('ThemeManager')) {
          addTestResult(section, 'pass', 'ThemeManager incluido en index.html');
        } else {
          addTestResult(section, 'fail', 'ThemeManager NO encontrado en index.html',
            'Debe incluir: script tag de themeManager.js');
        }
        
        // Verificar redirecci√≥n a YavlAgro.html
        if (indexResult.text.includes('YavlAgro.html')) {
          addTestResult(section, 'pass', 'Redirecci√≥n a YavlAgro.html configurada');
        } else {
          addTestResult(section, 'warn', 'Redirecci√≥n a YavlAgro.html no encontrada');
        }
      } else {
        addTestResult(section, 'fail', `/apps/agro/index.html NO accesible (Status: ${indexResult.status})`);
      }
      
      // Test YavlAgro.html
      const yavlResult = await testFetchPage('/apps/agro/YavlAgro.html');
      if (yavlResult.ok) {
        addTestResult(section, 'pass', '/apps/agro/YavlAgro.html existe y es accesible');
        
        // Verificar Supabase
        if (yavlResult.text.includes('supabase')) {
          addTestResult(section, 'pass', 'Supabase SDK incluido en YavlAgro.html');
        } else {
          addTestResult(section, 'fail', 'Supabase SDK NO encontrado en YavlAgro.html');
        }
        
        // Verificar ThemeManager
        if (yavlResult.text.includes('themeManager.js') || yavlResult.text.includes('ThemeManager')) {
          addTestResult(section, 'pass', 'ThemeManager incluido en YavlAgro.html');
        } else {
          addTestResult(section, 'fail', 'ThemeManager NO encontrado en YavlAgro.html');
        }
        
        // Verificar AuthGuard
        if (yavlResult.text.includes('checkAuth') || yavlResult.text.includes('auth.getSession')) {
          addTestResult(section, 'pass', 'AuthGuard implementado en YavlAgro.html');
        } else {
          addTestResult(section, 'fail', 'AuthGuard NO encontrado en YavlAgro.html');
        }
      } else {
        addTestResult(section, 'fail', `/apps/agro/YavlAgro.html NO accesible (Status: ${yavlResult.status})`);
      }
    }
    
    async function testDashboardLinks() {
      const section = addTestSection('2Ô∏è‚É£ Enlaces en Dashboard');
      
      const dashResult = await testFetchPage('/dashboard/index.html');
      if (dashResult.ok) {
        // Verificar que NO haya enlaces antiguos de GitHub
        const hasOldLinks = dashResult.text.includes('yavlpro.github.io/LaGritaAgricultora');
        if (!hasOldLinks) {
          addTestResult(section, 'pass', 'NO hay enlaces antiguos a GitHub Pages');
        } else {
          addTestResult(section, 'fail', 'Todav√≠a existen enlaces a yavlpro.github.io/LaGritaAgricultora',
            'Reemplazar con: /apps/agro/');
        }
        
        // Verificar enlace correcto a YavlAgro
        if (dashResult.text.includes('href="/apps/agro/')) {
          addTestResult(section, 'pass', 'Enlace correcto a /apps/agro/ encontrado');
        } else {
          addTestResult(section, 'fail', 'Enlace a /apps/agro/ NO encontrado en dashboard');
        }
        
        // Verificar enlace a YavlSuite
        if (dashResult.text.includes('href="/apps/suite/')) {
          addTestResult(section, 'pass', 'Enlace correcto a /apps/suite/ encontrado');
        } else {
          addTestResult(section, 'warn', 'Enlace a /apps/suite/ no encontrado');
        }
      } else {
        addTestResult(section, 'fail', 'Dashboard NO accesible');
      }
    }
    
    async function testAuthGuard() {
      const section = addTestSection('3Ô∏è‚É£ AuthGuard y Protecci√≥n');
      
      // Verificar si existe supabase.js
      const supabaseResult = await testFetchPage('/assets/js/supabase.js');
      if (supabaseResult.ok) {
        addTestResult(section, 'pass', '/assets/js/supabase.js existe');
      } else {
        addTestResult(section, 'fail', '/assets/js/supabase.js NO encontrado',
          'Este archivo es necesario para AuthGuard');
      }
      
      // Verificar auth.js
      const authResult = await testFetchPage('/assets/js/auth.js');
      if (authResult.ok) {
        addTestResult(section, 'pass', '/assets/js/auth.js existe');
      } else {
        addTestResult(section, 'warn', '/assets/js/auth.js no encontrado (puede ser normal)');
      }
      
      addTestResult(section, 'warn', 'La redirecci√≥n a /login.html es el comportamiento ESPERADO',
        'Si no est√°s autenticado, YavlAgro debe redirigir a login');
    }
    
    async function testThemeManager() {
      const section = addTestSection('4Ô∏è‚É£ Sistema de Temas');
      
      // Verificar themeManager.js
      const themeResult = await testFetchPage('/assets/js/themeManager.js');
      if (themeResult.ok) {
        addTestResult(section, 'pass', '/assets/js/themeManager.js existe');
        
        // Verificar que contiene las funciones necesarias
        if (themeResult.text.includes('ThemeManager') && 
            themeResult.text.includes('init') &&
            themeResult.text.includes('toggle')) {
          addTestResult(section, 'pass', 'ThemeManager tiene las funciones requeridas (init, toggle)');
        } else {
          addTestResult(section, 'warn', 'ThemeManager puede estar incompleto');
        }
      } else {
        addTestResult(section, 'fail', '/assets/js/themeManager.js NO encontrado',
          'Sin este archivo, los temas no funcionar√°n');
      }
      
      // Test en vivo del tema actual
      const currentTheme = document.documentElement.getAttribute('data-theme');
      if (currentTheme) {
        addTestResult(section, 'pass', `Tema actual aplicado: ${currentTheme}`);
      } else {
        addTestResult(section, 'warn', 'No hay tema aplicado en data-theme');
      }
      
      // Verificar localStorage
      const savedTheme = localStorage.getItem('gg:theme') || localStorage.getItem('theme');
      if (savedTheme) {
        addTestResult(section, 'pass', `Tema guardado en localStorage: ${savedTheme}`);
      } else {
        addTestResult(section, 'warn', 'No hay tema guardado en localStorage');
      }
    }
    
    async function testCalculadoraLinks() {
      const section = addTestSection('5Ô∏è‚É£ Calculadora');
      
      // Test archivo calculadora
      const calcResult = await testFetchPage('/herramientas/calculadora.html');
      if (calcResult.ok) {
        addTestResult(section, 'pass', '/herramientas/calculadora.html existe y es accesible');
      } else {
        addTestResult(section, 'fail', `/herramientas/calculadora.html NO accesible (Status: ${calcResult.status})`);
      }
      
      // Verificar enlaces en dashboard
      const dashResult = await testFetchPage('/dashboard/index.html');
      if (dashResult.ok && dashResult.text.includes('href="/herramientas/calculadora.html"')) {
        addTestResult(section, 'pass', 'Enlace a calculadora encontrado en dashboard');
        
        // Verificar data-protected
        const calcLinkMatch = dashResult.text.match(/href="\/herramientas\/calculadora\.html"[^>]*>/);
        if (calcLinkMatch && calcLinkMatch[0].includes('data-protected')) {
          addTestResult(section, 'pass', 'Enlace de calculadora tiene data-protected="true"');
        } else {
          addTestResult(section, 'warn', 'Enlace de calculadora puede NO estar protegido',
            'Agregar: data-protected="true"');
        }
      }
    }
    
    async function testMetadata() {
      const section = addTestSection('6Ô∏è‚É£ Metadatos y SEO');
      
      const yavlResult = await testFetchPage('/apps/agro/YavlAgro.html');
      if (yavlResult.ok) {
        // Verificar canonical
        if (yavlResult.text.includes('yavlgold.com/apps/agro')) {
          addTestResult(section, 'pass', 'Canonical URL correcto (yavlgold.com/apps/agro)');
        } else if (yavlResult.text.includes('yavlpro.github.io')) {
          addTestResult(section, 'fail', 'Canonical todav√≠a apunta a GitHub Pages',
            'Cambiar a: https://yavlgold.com/apps/agro/YavlAgro.html');
        } else {
          addTestResult(section, 'warn', 'Canonical URL no encontrado');
        }
        
        // Verificar Open Graph
        if (yavlResult.text.includes('og:url') && yavlResult.text.includes('yavlgold.com')) {
          addTestResult(section, 'pass', 'Open Graph URL correcto');
        } else {
          addTestResult(section, 'warn', 'Open Graph puede tener URL incorrecto');
        }
        
        // Verificar JSON-LD
        if (yavlResult.text.includes('application/ld+json')) {
          if (yavlResult.text.includes('yavlgold.com')) {
            addTestResult(section, 'pass', 'JSON-LD con URL correcto');
          } else {
            addTestResult(section, 'warn', 'JSON-LD puede tener URL antiguo');
          }
        }
      }
    }
    
    // Auto-ejecutar al cargar
    window.addEventListener('load', () => {
      // Inicializar ThemeManager si est√° disponible
      if (typeof ThemeManager !== 'undefined') {
        ThemeManager.init();
        console.log('[Test] ‚úÖ ThemeManager inicializado');
      }
      
      setTimeout(runAllTests, 500);
    });
  </script>
</body>
</html>
