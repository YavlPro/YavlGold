<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test DELETE Direct - YavlGold</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0B0C0F;
      color: #E5E5E5;
      font-family: 'Courier New', monospace;
      padding: 40px;
      line-height: 1.8;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    h1 {
      color: #C8A752;
      margin-bottom: 30px;
      text-align: center;
      font-family: 'Segoe UI', sans-serif;
    }
    .test-section {
      background: #1a1a1a;
      padding: 25px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 2px solid #333;
    }
    .test-section h2 {
      color: #C8A752;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }
    button {
      background: #C8A752;
      color: #0B0C0F;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
      font-size: 1rem;
    }
    button:hover {
      opacity: 0.8;
    }
    .btn-danger {
      background: #f44336;
      color: #fff;
    }
    .btn-success {
      background: #4caf50;
      color: #fff;
    }
    .log-container {
      background: #0B0C0F;
      padding: 20px;
      border-radius: 6px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #333;
    }
    .log-entry {
      padding: 8px;
      margin: 5px 0;
      border-left: 3px solid #666;
      padding-left: 12px;
    }
    .log-success { border-left-color: #4caf50; color: #4caf50; }
    .log-error { border-left-color: #f44336; color: #f44336; }
    .log-info { border-left-color: #2196f3; color: #2196f3; }
    .log-warning { border-left-color: #ff9800; color: #ff9800; }
    .info-box {
      background: #2a2a2a;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #2196f3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🧪 Test Directo de DELETE</h1>
    
    <div class="info-box">
      <strong>📋 Este test hace lo siguiente:</strong>
      <ol style="margin-left: 20px; margin-top: 10px;">
        <li>Verifica tu sesión actual</li>
        <li>Verifica tu perfil y si eres admin</li>
        <li>Lista todos los anuncios</li>
        <li>Intenta eliminar un anuncio usando DELETE directo de Supabase</li>
        <li>Muestra exactamente qué retorna la base de datos</li>
      </ol>
    </div>

    <div class="test-section">
      <h2>Paso 1: Verificar Sesión y Perfil</h2>
      <button onclick="checkSession()">🔍 Verificar Sesión</button>
      <button onclick="checkProfile()">👤 Verificar Perfil</button>
      <button onclick="checkAdmin()">🔒 Verificar Admin</button>
    </div>

    <div class="test-section">
      <h2>Paso 2: Ver Anuncios</h2>
      <button onclick="listAnnouncements()">📋 Listar Anuncios</button>
    </div>

    <div class="test-section">
      <h2>Paso 3: Eliminar Anuncio (Directo)</h2>
      <p style="margin-bottom: 15px;">Introduce el ID del anuncio a eliminar:</p>
      <input 
        type="text" 
        id="announcement-id" 
        placeholder="UUID del anuncio"
        style="width: 100%; padding: 12px; background: #0B0C0F; color: #E5E5E5; border: 1px solid #333; border-radius: 6px; font-family: 'Courier New', monospace; margin-bottom: 15px;"
      >
      <button class="btn-danger" onclick="deleteDirectly()">🗑️ DELETE Directo (Supabase)</button>
      <button onclick="deleteViaManager()">🔧 DELETE via Manager</button>
    </div>

    <div class="log-container" id="log"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/assets/js/auth/authClient.js"></script>
  <script src="/assets/js/profile/profileManager.js"></script>
  <script src="/assets/js/announcements/announcementsManager.js"></script>
  
  <script>
    function log(message, type = 'info') {
      const logContainer = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
      console.log(message);
    }

    async function checkSession() {
      log('Verificando sesión...', 'info');
      
      const session = AuthClient.getSession();
      
      if (!session) {
        log('❌ No hay sesión activa', 'error');
        return;
      }
      
      log(`✅ Sesión activa`, 'success');
      log(`   User ID: ${session.user.id}`, 'info');
      log(`   Email: ${session.user.email}`, 'info');
      log(`   Token presente: ${session.access_token ? 'Sí' : 'No'}`, 'info');
    }

    async function checkProfile() {
      log('Verificando perfil en BD...', 'info');
      
      try {
        const session = AuthClient.getSession();
        if (!session) {
          log('❌ No hay sesión', 'error');
          return;
        }

        // Consulta DIRECTA a profiles
        const { data, error } = await AuthClient.supabase
          .from('profiles')
          .select('*')
          .eq('id', session.user.id)
          .single();

        if (error) {
          log(`❌ Error al obtener perfil: ${error.message}`, 'error');
          log(`   Código: ${error.code}`, 'error');
          return;
        }

        log('✅ Perfil obtenido:', 'success');
        log(`   ID: ${data.id}`, 'info');
        log(`   Username: ${data.username}`, 'info');
        log(`   Email: ${data.email}`, 'info');
        log(`   is_admin: ${data.is_admin}`, data.is_admin ? 'success' : 'warning');
        
      } catch (err) {
        log(`❌ Excepción: ${err.message}`, 'error');
      }
    }

    async function checkAdmin() {
      log('Verificando status de admin...', 'info');
      
      const result = await ProfileManager.isAdmin(AuthClient.getSession()?.user?.id);
      
      if (result.success) {
        log(`✅ Resultado: isAdmin = ${result.isAdmin}`, result.isAdmin ? 'success' : 'warning');
      } else {
        log(`❌ Error: ${result.error}`, 'error');
      }
    }

    async function listAnnouncements() {
      log('Listando anuncios...', 'info');
      
      try {
        const { data, error } = await AuthClient.supabase
          .from('announcements')
          .select('id, title, author_id, created_at')
          .order('created_at', { ascending: false });

        if (error) {
          log(`❌ Error: ${error.message}`, 'error');
          return;
        }

        log(`✅ Total de anuncios: ${data.length}`, 'success');
        
        data.forEach((ann, index) => {
          const isMine = ann.author_id === AuthClient.getSession()?.user?.id;
          log(`   ${index + 1}. ${ann.title}`, 'info');
          log(`      ID: ${ann.id}`, 'info');
          log(`      Autor: ${ann.author_id} ${isMine ? '(TÚ)' : ''}`, isMine ? 'success' : 'info');
        });

      } catch (err) {
        log(`❌ Excepción: ${err.message}`, 'error');
      }
    }

    async function deleteDirectly() {
      const id = document.getElementById('announcement-id').value.trim();
      
      if (!id) {
        log('❌ Debes introducir un ID', 'error');
        return;
      }

      log(`🗑️ Intentando DELETE directo de: ${id}`, 'warning');
      
      try {
        // DELETE DIRECTO sin usar el manager
        const { data, error } = await AuthClient.supabase
          .from('announcements')
          .delete()
          .eq('id', id);

        log('📊 Respuesta de Supabase:', 'info');
        log(`   data: ${JSON.stringify(data)}`, 'info');
        log(`   error: ${JSON.stringify(error)}`, error ? 'error' : 'info');

        if (error) {
          log(`❌ ERROR al eliminar: ${error.message}`, 'error');
          log(`   Código: ${error.code}`, 'error');
          log(`   Detalles: ${error.details}`, 'error');
          log(`   Hint: ${error.hint}`, 'error');
        } else {
          log('✅ DELETE ejecutado SIN errores', 'success');
          log('   Recargando lista...', 'info');
          
          setTimeout(() => listAnnouncements(), 500);
        }

      } catch (err) {
        log(`❌ Excepción: ${err.message}`, 'error');
      }
    }

    async function deleteViaManager() {
      const id = document.getElementById('announcement-id').value.trim();
      
      if (!id) {
        log('❌ Debes introducir un ID', 'error');
        return;
      }

      log(`🔧 Intentando DELETE via Manager: ${id}`, 'warning');
      
      try {
        const result = await AnnouncementsManager.deleteAnnouncement(id);

        log('📊 Respuesta del Manager:', 'info');
        log(`   success: ${result.success}`, result.success ? 'success' : 'error');
        log(`   error: ${result.error || 'ninguno'}`, result.error ? 'error' : 'info');

        if (result.success) {
          log('✅ Manager reporta éxito', 'success');
          log('   Recargando lista...', 'info');
          
          setTimeout(() => listAnnouncements(), 500);
        } else {
          log(`❌ Manager reporta error: ${result.error}`, 'error');
        }

      } catch (err) {
        log(`❌ Excepción: ${err.message}`, 'error');
      }
    }

    // Auto-inicializar
    window.addEventListener('DOMContentLoaded', async () => {
      log('🚀 Test directo iniciado', 'info');
      log('Esperando a que se carguen los managers...', 'info');
      
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      log('✅ Listo para probar', 'success');
      log('', 'info');
      log('📝 Instrucciones:', 'warning');
      log('1. Verifica tu sesión y perfil', 'info');
      log('2. Lista los anuncios para ver sus IDs', 'info');
      log('3. Copia un ID e intenta eliminarlo', 'info');
      log('4. Compara DELETE directo vs via Manager', 'info');
    });
  </script>
</body>
</html>
