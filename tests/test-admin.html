<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Admin - YavlGold</title>
  <style>
    body {
      background: #0B0C0F;
      color: #E5E5E5;
      font-family: 'Courier New', monospace;
      padding: 40px;
      max-width: 1000px;
      margin: 0 auto;
    }
    .test-card {
      background: #1a1a1a;
      border: 2px solid #C8A752;
      border-radius: 12px;
      padding: 25px;
      margin: 20px 0;
    }
    .success { border-color: #4CAF50; }
    .error { border-color: #f44336; }
    .warning { border-color: #ff9800; }
    button {
      background: linear-gradient(135deg, #C8A752 0%, #8B7842 100%);
      color: #0B0C0F;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 10px 5px;
      font-size: 1rem;
    }
    button:hover { opacity: 0.9; transform: translateY(-2px); transition: 0.2s; }
    pre {
      background: #000;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 0.9rem;
    }
    .badge {
      background: #C8A752;
      color: #0B0C0F;
      padding: 6px 15px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: bold;
      display: inline-block;
      margin-left: 10px;
    }
    .status-icon {
      font-size: 3rem;
      margin: 10px 0;
    }
    h1 { 
      background: linear-gradient(135deg, #C8A752 0%, #FFD700 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .test-section {
      margin: 30px 0;
      padding: 20px;
      background: rgba(200, 167, 82, 0.05);
      border-radius: 8px;
    }
    .checklist {
      list-style: none;
      padding: 0;
    }
    .checklist li {
      padding: 10px;
      margin: 5px 0;
      background: rgba(255,255,255,0.03);
      border-radius: 6px;
    }
    .checklist li::before {
      content: "‚è≥ ";
      margin-right: 10px;
    }
    .checklist li.done::before {
      content: "‚úÖ ";
    }
    .checklist li.fail::before {
      content: "‚ùå ";
    }
  </style>
</head>
<body>
  <h1>üëë Test de Permisos de Administrador</h1>
  <p>Verificaci√≥n completa del sistema de roles y permisos</p>

  <div class="test-section">
    <h2>üìã Tests Disponibles</h2>
    <button onclick="runAllTests()">üöÄ Ejecutar Todos los Tests</button>
    <button onclick="test1_CheckAdminStatus()">1Ô∏è‚É£ Verificar Estado Admin</button>
    <button onclick="test2_GetProfile()">2Ô∏è‚É£ Obtener Mi Perfil</button>
    <button onclick="test3_TestAnnouncementCreation()">3Ô∏è‚É£ Test Crear Anuncio</button>
    <button onclick="test4_TestAuthGuardRoles()">4Ô∏è‚É£ Test AuthGuard Roles</button>
    <button onclick="clearResults()">üóëÔ∏è Limpiar Resultados</button>
  </div>

  <div id="results"></div>

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Auth & Managers -->
    <script src="/assets/js/auth/authClient.js"></script>
  <script src="/assets/js/profile/profileManager.js?v=3"></script>
  <script src="/assets/js/announcements/announcementsManager.js"></script>
  <script src="/assets/js/auth/authGuard.js?v=2"></script>

  <script>
    const resultsDiv = document.getElementById('results');
    const YOUR_ADMIN_ID = '68a4963b-2b86-4382-a04f-1f38f1873d1c';

    function showResult(title, content, type = 'success') {
      const card = document.createElement('div');
      card.className = `test-card ${type}`;
      
      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è';
      
      card.innerHTML = `
        <div class="status-icon">${icon}</div>
        <h3>${title}</h3>
        <div>${content}</div>
      `;
      resultsDiv.appendChild(card);
      
      // Auto-scroll
      card.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }

    function clearResults() {
      resultsDiv.innerHTML = '';
    }

    // TEST 1: Verificar estado admin
    async function test1_CheckAdminStatus() {
      showResult('‚è≥ Test 1: Verificando estado de administrador...', 'Consultando base de datos...', 'warning');

      try {
        const result = await ProfileManager.isAdmin(YOUR_ADMIN_ID);
        
        if (result.success && result.isAdmin) {
          showResult(
            'Test 1: Estado Admin ‚úÖ',
            `
              <div class="status-icon">üëë</div>
              <p style="font-size: 1.5rem; font-weight: bold; color: #4CAF50;">
                CONFIRMADO: Eres ADMINISTRADOR
              </p>
              <pre>${JSON.stringify(result, null, 2)}</pre>
              <p><strong>Implicaciones:</strong></p>
              <ul>
                <li>‚úÖ Puedes crear anuncios</li>
                <li>‚úÖ Puedes editar cualquier anuncio</li>
                <li>‚úÖ Puedes eliminar anuncios</li>
                <li>‚úÖ El bot√≥n "Crear Anuncio" debe aparecer en dashboard</li>
              </ul>
            `,
            'success'
          );
        } else {
          showResult(
            'Test 1: Estado Admin ‚ùå',
            `
              <p style="color: #f44336;">NO ERES ADMINISTRADOR</p>
              <pre>${JSON.stringify(result, null, 2)}</pre>
              <p>Verifica que el UPDATE se ejecut√≥ correctamente en Supabase.</p>
            `,
            'error'
          );
        }
      } catch (error) {
        showResult(
          'Test 1: Error ‚ùå',
          `<pre>${error.message}</pre>`,
          'error'
        );
      }
    }

    // TEST 2: Obtener perfil completo
    async function test2_GetProfile() {
      showResult('‚è≥ Test 2: Obteniendo perfil completo...', 'Consultando profiles...', 'warning');

      try {
        const result = await ProfileManager.getProfile(YOUR_ADMIN_ID);
        
        if (result.success) {
          const p = result.profile;
          showResult(
            'Test 2: Perfil Obtenido ‚úÖ',
            `
              <div style="display: flex; align-items: center; gap: 20px; margin: 20px 0;">
                <img src="${p.avatar_url}" alt="${p.username}" 
                     style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid #C8A752;"
                     onerror="this.src='https://ui-avatars.com/api/?name=Error&background=C8A752&color=0B0C0F'">
                <div>
                  <h3>${p.username} ${p.is_admin ? '<span class="badge">ADMIN</span>' : ''}</h3>
                  <p><strong>Email:</strong> ${p.email}</p>
                  <p><strong>Bio:</strong> ${p.bio || '(sin biograf√≠a)'}</p>
                </div>
              </div>
              <p><strong>Metadatos:</strong></p>
              <pre>${JSON.stringify(p, null, 2)}</pre>
              <p><strong>Verificaciones:</strong></p>
              <ul class="checklist">
                <li class="${p.username ? 'done' : 'fail'}">Username: ${p.username}</li>
                <li class="${p.email ? 'done' : 'fail'}">Email: ${p.email}</li>
                <li class="${p.avatar_url ? 'done' : 'fail'}">Avatar URL configurado</li>
                <li class="${p.is_admin ? 'done' : 'fail'}">Estado Admin: ${p.is_admin}</li>
                <li class="${p.updated_at ? 'done' : 'fail'}">√öltima actualizaci√≥n: ${new Date(p.updated_at).toLocaleString('es-ES')}</li>
              </ul>
            `,
            'success'
          );
        } else {
          showResult('Test 2: Error ‚ùå', `<pre>${JSON.stringify(result, null, 2)}</pre>`, 'error');
        }
      } catch (error) {
        showResult('Test 2: Excepci√≥n ‚ùå', `<pre>${error.message}</pre>`, 'error');
      }
    }

    // TEST 3: Intentar crear anuncio
    async function test3_TestAnnouncementCreation() {
      showResult('‚è≥ Test 3: Probando creaci√≥n de anuncio...', 'Verificando permisos...', 'warning');

      try {
        // Primero verificar que hay sesi√≥n
        const session = AuthClient.getSession();
        if (!session || !session.user) {
          showResult(
            'Test 3: Sin Sesi√≥n ‚ö†Ô∏è',
            `
              <p>No hay sesi√≥n activa. Para crear anuncios necesitas:</p>
              <ol>
                <li>Ir a <a href="/dashboard/" style="color: #C8A752;">/dashboard/</a></li>
                <li>Iniciar sesi√≥n con tu cuenta de admin</li>
                <li>Volver a esta p√°gina y ejecutar el test</li>
              </ol>
              <p>O ejecuta este test desde el dashboard directamente.</p>
            `,
            'warning'
          );
          return;
        }

        // Crear anuncio de prueba
        const testTitle = `üß™ Test Anuncio - ${new Date().toLocaleTimeString()}`;
        const testContent = `Este es un anuncio de prueba creado por el sistema de testing.\n\nSi ves este mensaje, significa que:\n‚úÖ Tu usuario es admin\n‚úÖ Las pol√≠ticas RLS est√°n configuradas correctamente\n‚úÖ El sistema de anuncios funciona\n\nCreado: ${new Date().toLocaleString('es-ES')}`;

        const result = await AnnouncementsManager.createAnnouncement(testTitle, testContent);

        if (result.success) {
          showResult(
            'Test 3: Anuncio Creado ‚úÖ',
            `
              <div class="status-icon">üì¢</div>
              <p style="font-size: 1.3rem; color: #4CAF50; font-weight: bold;">
                ¬°ANUNCIO CREADO EXITOSAMENTE!
              </p>
              <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h4 style="margin: 0 0 10px 0;">${result.announcement.title}</h4>
                <p style="white-space: pre-wrap; margin: 10px 0;">${result.announcement.content}</p>
                <small>ID: ${result.announcement.id}</small>
              </div>
              <p><strong>Pr√≥ximos pasos:</strong></p>
              <ul>
                <li>Ve a <a href="/dashboard/" style="color: #C8A752;">/dashboard/</a></li>
                <li>Verifica que el anuncio aparece en el feed</li>
                <li>Prueba editarlo y eliminarlo</li>
              </ul>
              <pre>${JSON.stringify(result, null, 2)}</pre>
            `,
            'success'
          );
        } else {
          showResult(
            'Test 3: Error al Crear ‚ùå',
            `
              <p style="color: #f44336;">No se pudo crear el anuncio</p>
              <p><strong>Error:</strong> ${result.error}</p>
              <pre>${JSON.stringify(result, null, 2)}</pre>
              <p><strong>Posibles causas:</strong></p>
              <ul>
                <li>is_admin no est√° en true en la BD</li>
                <li>Pol√≠ticas RLS bloqueando INSERT</li>
                <li>Session no tiene el user.id correcto</li>
              </ul>
            `,
            'error'
          );
        }
      } catch (error) {
        showResult('Test 3: Excepci√≥n ‚ùå', `<pre>${error.message}\n${error.stack}</pre>`, 'error');
      }
    }

    // TEST 4: Verificar AuthGuard roles
    async function test4_TestAuthGuardRoles() {
      showResult('‚è≥ Test 4: Probando AuthGuard.hasRole()...', 'Verificando roles desde BD...', 'warning');

      try {
        // Usar la sesi√≥n actual (ya autenticada con JWT real)
        const currentUser = AuthClient.getCurrentUser();
        
        if (!currentUser) {
          throw new Error('No hay usuario autenticado. Por favor haz login primero.');
        }

        console.log('[Test 4] Usuario actual:', currentUser.id, currentUser.email);

        const hasAdminRole = await AuthGuard.hasRole('admin');

        if (hasAdminRole) {
          showResult(
            'Test 4: AuthGuard Roles ‚úÖ',
            `
              <div class="status-icon">üõ°Ô∏è</div>
              <p style="font-size: 1.3rem; color: #4CAF50; font-weight: bold;">
                AuthGuard reconoce permisos de ADMIN
              </p>
              <p><strong>Resultado:</strong> hasRole('admin') = <code>true</code></p>
              <p>Esto significa que:</p>
              <ul class="checklist">
                <li class="done">AuthGuard consulta is_admin desde profiles (no sesi√≥n)</li>
                <li class="done">Elementos con data-role="admin" se mostrar√°n</li>
                <li class="done">Bot√≥n "Crear Anuncio" debe aparecer en dashboard</li>
              </ul>
              <p><strong>Nota:</strong> Aunque el rol en sesi√≥n es "user", AuthGuard correctamente consulta la BD y detecta que eres admin.</p>
            `,
            'success'
          );
        } else {
          showResult(
            'Test 4: AuthGuard Roles ‚ùå',
            `
              <p style="color: #f44336;">AuthGuard NO reconoce permisos admin</p>
              <p>Resultado: hasRole('admin') = false</p>
              <p>Revisa que AuthGuard.js est√© actualizado con la versi√≥n que consulta ProfileManager.</p>
            `,
            'error'
          );
        }
      } catch (error) {
        showResult('Test 4: Error ‚ùå', `<pre>${error.message}</pre>`, 'error');
      }
    }

    // Ejecutar todos los tests en secuencia
    async function runAllTests() {
      clearResults();
      
      showResult(
        'üöÄ Iniciando Suite Completa de Tests',
        `
          <p>Ejecutando 4 tests en secuencia...</p>
          <ul class="checklist">
            <li>Test 1: Verificar estado admin en BD</li>
            <li>Test 2: Obtener perfil completo</li>
            <li>Test 3: Crear anuncio de prueba</li>
            <li>Test 4: Verificar AuthGuard roles</li>
          </ul>
        `,
        'warning'
      );

      await new Promise(resolve => setTimeout(resolve, 1000));
      await test1_CheckAdminStatus();
      
      await new Promise(resolve => setTimeout(resolve, 1500));
      await test2_GetProfile();
      
      await new Promise(resolve => setTimeout(resolve, 1500));
      await test3_TestAnnouncementCreation();
      
      await new Promise(resolve => setTimeout(resolve, 1500));
      await test4_TestAuthGuardRoles();

      await new Promise(resolve => setTimeout(resolve, 1000));
      showResult(
        'üéâ Suite de Tests Completada',
        `
          <p>Todos los tests han finalizado.</p>
          <p><strong>Pr√≥ximos pasos:</strong></p>
          <ol>
            <li>Revisa los resultados arriba</li>
            <li>Si todos pasaron ‚úÖ, ve al dashboard y prueba crear anuncios</li>
            <li>Si alguno fall√≥ ‚ùå, revisa la consola del navegador para m√°s detalles</li>
          </ol>
        `,
        'success'
      );
    }

    // Auto-inicializar
    window.addEventListener('load', () => {
      setTimeout(() => {
        showResult(
          'üîß Sistema Inicializado',
          `
            <p><strong>Managers disponibles:</strong></p>
            <ul class="checklist">
              <li class="${window.AuthClient ? 'done' : 'fail'}">AuthClient</li>
              <li class="${window.ProfileManager ? 'done' : 'fail'}">ProfileManager</li>
              <li class="${window.AnnouncementsManager ? 'done' : 'fail'}">AnnouncementsManager</li>
              <li class="${window.AuthGuard ? 'done' : 'fail'}">AuthGuard</li>
              <li class="${window.supabase ? 'done' : 'fail'}">Supabase Client</li>
            </ul>
            <p><strong>Tu ID de Admin:</strong> <code>${YOUR_ADMIN_ID}</code></p>
            <p>Haz clic en "Ejecutar Todos los Tests" para comenzar.</p>
          `,
          'success'
        );
      }, 500);
    });
  </script>
</body>
</html>
