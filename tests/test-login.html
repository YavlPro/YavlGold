<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîë Login Real para Tests - YavlGold</title>
  <style>
    body {
      background: #0B0C0F;
      color: #E5E5E5;
      font-family: 'Courier New', monospace;
      padding: 40px;
      max-width: 600px;
      margin: 0 auto;
    }
    .card {
      background: #1a1a1a;
      border: 2px solid #C8A752;
      border-radius: 12px;
      padding: 30px;
      margin: 20px 0;
    }
    input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      background: #000;
      border: 1px solid #C8A752;
      border-radius: 6px;
      color: #E5E5E5;
      font-size: 1rem;
    }
    button {
      background: linear-gradient(135deg, #C8A752 0%, #8B7842 100%);
      color: #0B0C0F;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 10px 0;
      font-size: 1rem;
      width: 100%;
    }
    button:hover { opacity: 0.9; }
    .success { color: #4CAF50; }
    .error { color: #f44336; }
    pre {
      background: #000;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 0.85rem;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>

  <h1>üîë Login Real con Supabase</h1>
  
  <div class="card">
    <h2>Autenticaci√≥n de Prueba</h2>
    <p>Elige tu m√©todo de autenticaci√≥n con Supabase:</p>
    
    <div style="margin: 20px 0; padding: 15px; background: #000; border-radius: 8px;">
      <h3 style="color: #C8A752; margin-top: 0;">üîë M√©todo 1: Con Contrase√±a</h3>
      <form id="loginForm">
        <label>Email:</label>
        <input type="email" id="email" value="yeriksonvarela@gmail.com" required>
        
        <label>Contrase√±a:</label>
        <input type="password" id="password" placeholder="Tu contrase√±a de Supabase" required>
        
        <button type="submit">üöÄ Login con Contrase√±a</button>
      </form>
    </div>

    <div style="margin: 20px 0; padding: 15px; background: #000; border-radius: 8px;">
      <h3 style="color: #C8A752; margin-top: 0;">üìß M√©todo 2: Magic Link (Sin contrase√±a)</h3>
      <p style="font-size: 0.9rem; opacity: 0.8;">Te enviaremos un link de acceso a tu email</p>
      <button onclick="sendMagicLink()" type="button">‚ú® Enviar Magic Link</button>
    </div>
    
    <div id="result" style="margin-top: 20px;"></div>
  </div>

  <div class="card" id="sessionInfo" style="display: none;">
    <h3>‚úÖ Sesi√≥n Activa</h3>
    <p><strong>User ID:</strong> <code id="userId"></code></p>
    <p><strong>Email:</strong> <code id="userEmail"></code></p>
    <p><strong>JWT Token:</strong></p>
    <pre id="jwtToken" style="word-break: break-all; white-space: pre-wrap;"></pre>
    
    <button onclick="refreshToken()" style="background: #ff9800;">
      üîÑ Obtener JWT de Supabase
    </button>
    
    <button onclick="window.location.href='/test-admin.html'">
      üìä Ir a Tests de Admin
    </button>
    
    <button onclick="logout()" style="background: #f44336;">
      üö™ Cerrar Sesi√≥n
    </button>
  </div>

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/assets/js/auth/authClient.js"></script>

  <script>
    const resultDiv = document.getElementById('result');

    // Inicializar AuthClient
    AuthClient.init();

    // Verificar sesi√≥n existente
    window.addEventListener('DOMContentLoaded', async () => {
      // Primero, intentar obtener sesi√≥n de Supabase directamente
      const { data: { session: supabaseSession }, error } = await AuthClient.supabase.auth.getSession();
      
      if (supabaseSession) {
        console.log('[Test Login] ‚úÖ Sesi√≥n de Supabase encontrada:', supabaseSession.user.email);
        
        // Guardar sesi√≥n con JWT real
        AuthClient.currentSession = {
          user: {
            id: supabaseSession.user.id,
            email: supabaseSession.user.email,
            name: supabaseSession.user.user_metadata?.name || supabaseSession.user.email.split('@')[0],
            role: 'user'
          },
          access_token: supabaseSession.access_token,
          refresh_token: supabaseSession.refresh_token,
          expires_at: new Date(supabaseSession.expires_at * 1000).toISOString()
        };
        
        AuthClient.saveSession(AuthClient.currentSession);
        showSessionInfo(AuthClient.currentSession);
        return;
      }
      
      // Si no hay sesi√≥n de Supabase, verificar localStorage
      const session = AuthClient.getSession();
      if (session && session.user) {
        showSessionInfo(session);
      }
    });

    // Manejar login con contrase√±a
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      resultDiv.innerHTML = '<p style="color: #ff9800;">‚è≥ Autenticando con contrase√±a...</p>';

      try {
        // Login REAL con Supabase
        const { data, error } = await AuthClient.supabase.auth.signInWithPassword({
          email: email,
          password: password
        });

        if (error) throw error;

        if (data.session) {
          saveSession(data);
        }

      } catch (error) {
        resultDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
        console.error('[Login Real] ‚ùå', error);
      }
    });

    // Manejar Magic Link
    async function sendMagicLink() {
      const email = document.getElementById('email').value;
      
      if (!email) {
        resultDiv.innerHTML = '<p class="error">‚ùå Por favor ingresa un email</p>';
        return;
      }

      resultDiv.innerHTML = '<p style="color: #ff9800;">‚è≥ Enviando Magic Link...</p>';

      try {
        const { data, error } = await AuthClient.supabase.auth.signInWithOtp({
          email: email,
          options: {
            emailRedirectTo: 'http://localhost:8080/test-login.html'
          }
        });

        if (error) throw error;

        resultDiv.innerHTML = `
          <div style="padding: 20px; background: #1a4d1a; border-radius: 8px; border: 2px solid #4CAF50;">
            <p class="success" style="font-size: 1.2rem; margin: 0 0 10px 0;">‚úÖ Magic Link enviado!</p>
            <p style="font-size: 0.95rem; opacity: 0.9;">
              üìß Revisa tu email: <strong>${email}</strong><br>
              üîó Click en el link para autenticarte<br>
              ‚è±Ô∏è El link expira en 1 hora
            </p>
          </div>
        `;

        console.log('[Magic Link] ‚úÖ Enviado a:', email);

      } catch (error) {
        resultDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
        console.error('[Magic Link] ‚ùå', error);
      }
    }

    function saveSession(data) {
      // Guardar sesi√≥n
      AuthClient.currentSession = {
        user: {
          id: data.user.id,
          email: data.user.email,
          name: data.user.user_metadata?.name || data.user.email.split('@')[0],
          role: 'user'
        },
        access_token: data.session.access_token,
        refresh_token: data.session.refresh_token,
        expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
      };
      
      AuthClient.saveSession(AuthClient.currentSession);

      resultDiv.innerHTML = '<p class="success">‚úÖ Login exitoso!</p>';
      showSessionInfo(AuthClient.currentSession);

      console.log('[Login Real] ‚úÖ Sesi√≥n creada con JWT real:', data.session.access_token.substring(0, 50) + '...');
    }

    function showSessionInfo(session) {
      document.getElementById('loginForm').parentElement.style.display = 'none';
      document.querySelector('[onclick="sendMagicLink()"]').parentElement.style.display = 'none';
      document.getElementById('sessionInfo').style.display = 'block';
      document.getElementById('userId').textContent = session.user.id;
      document.getElementById('userEmail').textContent = session.user.email;
      document.getElementById('jwtToken').textContent = session.access_token || 'N/A - Click en "Obtener JWT de Supabase"';
    }

    async function refreshToken() {
      try {
        const { data: { session }, error } = await AuthClient.supabase.auth.getSession();
        
        if (error) throw error;
        
        if (session && session.access_token) {
          document.getElementById('jwtToken').textContent = session.access_token;
          
          // Actualizar sesi√≥n guardada
          AuthClient.currentSession.access_token = session.access_token;
          AuthClient.saveSession(AuthClient.currentSession);
          
          resultDiv.innerHTML = '<p class="success">‚úÖ JWT obtenido de Supabase!</p>';
          console.log('[JWT] ‚úÖ Token actualizado:', session.access_token.substring(0, 50) + '...');
        } else {
          throw new Error('No hay sesi√≥n activa en Supabase');
        }
      } catch (error) {
        resultDiv.innerHTML = `<p class="error">‚ùå ${error.message}</p>`;
        console.error('[JWT] ‚ùå', error);
      }
    }

    async function logout() {
      await AuthClient.supabase.auth.signOut();
      AuthClient.clearSession();
      location.reload();
    }
  </script>

</body>
</html>
