<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YavlGold Crypto - Market Data</title>
    <meta name="description" content="YavlGold Crypto market data V1.">
    <meta property="og:title" content="YavlGold Crypto - Market Data">
    <link rel="icon" type="image/webp" href="/brand/logo.webp">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/tokens.css">
    <link rel="stylesheet" href="./crypto.css">
</head>

<body class="crypto-page">
    <header class="crypto-header">
        <nav class="crypto-nav" aria-label="Navegacion principal">
            <a class="nav-back" href="/dashboard/" aria-label="Volver al dashboard">
                <i class="fas fa-arrow-left" aria-hidden="true"></i>
                <span>Atras</span>
            </a>
            <div class="nav-title">MERCADO</div>
            <button id="notification-bell" class="nav-icon btn-notification notification-bell" type="button"
                aria-label="Notificaciones" title="Notificaciones">
                <i class="fas fa-bell" aria-hidden="true"></i>
                <span id="notification-badge" class="notification-badge" style="display: none;">0</span>
            </button>
        </nav>
    </header>

    <main class="crypto-main">
        <div class="crypto-container">
            <section class="crypto-hero">
                <div class="crypto-brand">
                    <img src="/brand/logo.webp" alt="YavlGold" class="logo">
                    <div class="crypto-heading">
                        <h1 class="title">YAVLGOLD CRYPTO</h1>
                        <p class="subtitle">Market Data V1</p>
                    </div>
                </div>

                <div class="status-badge">
                    <span class="status-dot" aria-hidden="true"></span>
                    <span class="status-text" id="market-status-text">CONECTANDO</span>
                </div>

                <p class="description">
                    Datos publicos de Binance para spot market. Actualizacion automatica cada 20s.
                </p>
            </section>

            <section class="crypto-panels">
                <div class="fng-card" id="fng-card" data-state="neutral">
                    <div class="fng-header">
                        <h2 class="fng-title">Fear & Greed Index</h2>
                        <span class="fng-updated" id="fng-updated">--</span>
                    </div>
                    <div class="fng-bar">
                        <span class="fng-marker" id="fng-marker" aria-hidden="true"></span>
                    </div>
                    <div class="fng-scale">
                        <span>0</span>
                        <span>25</span>
                        <span>50</span>
                        <span>75</span>
                        <span>100</span>
                    </div>
                    <div class="fng-value">
                        <span class="fng-number" id="fng-value">--</span>
                        <span class="fng-label" id="fng-label">Cargando</span>
                    </div>
                    <div class="fng-error" id="fng-error" aria-live="polite"></div>
                </div>

                <div class="market">
                    <div class="market-header">
                        <h2 class="market-title">Spot Market</h2>
                        <span class="market-updated" id="market-updated">--</span>
                    </div>
                    <div class="market-grid" id="market-grid"></div>
                    <div class="market-error" id="market-error" aria-live="polite"></div>
                </div>
            </section>
        </div>
    </main>

    <footer class="crypto-footer" id="app-footer">
        <p>(c) <span id="footer-year">2026</span> YavlGold - Open Source (MIT License)</p>
        <p class="footer-meta">Version <span id="footer-version">9.4.0</span> - Pulso Vital -
            <a class="footer-link" href="/">Inicio</a></p>
    </footer>

    <script type="module" src="../assets/js/utils/activityTracker.js"></script>
    <script type="module" src="./crypto.js"></script>
    <script type="module">
        import { NotificationsManager } from '../assets/js/components/notifications.js';

        window.YGActivity?.attachModuleTracking('crypto', { title: 'Crypto', path: '/crypto/' });
        NotificationsManager.init();

        const SPARKLINE_POINTS = 12;
        const SPARKLINE_WIDTH = 100;
        const SPARKLINE_HEIGHT = 40;
        const SPARKLINE_COLORS = {
            up: '#00ff88',
            down: '#ff0055'
        };

        const clamp = (value, min, max) => Math.min(Math.max(value, min), max);

        function hashString(value) {
            let hash = 0;
            for (let i = 0; i < value.length; i += 1) {
                hash = ((hash << 5) - hash) + value.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash);
        }

        function mulberry32(seed) {
            return function () {
                let t = seed += 0x6D2B79F5;
                t = Math.imul(t ^ (t >>> 15), t | 1);
                t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
                return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
            };
        }

        function getChangeDirection(changeEl) {
            if (!changeEl) return 'up';
            if (changeEl.classList.contains('down')) return 'down';
            if (changeEl.classList.contains('up')) return 'up';
            const text = (changeEl.textContent || '').trim();
            return text.startsWith('-') ? 'down' : 'up';
        }

        function getSymbolKey(card, index) {
            const pairEl = card.querySelector('.market-pair');
            const raw = (pairEl?.textContent || '').trim();
            if (raw) return raw.replace('/', '');
            return `card-${index}`;
        }

        function buildSparklinePoints(seed, direction) {
            const rand = mulberry32(seed);
            const drift = direction === 'down' ? -0.03 : 0.03;
            let value = direction === 'down' ? 0.7 : 0.3;
            const points = [];

            for (let i = 0; i < SPARKLINE_POINTS; i += 1) {
                const noise = (rand() - 0.5) * 0.18;
                value = clamp(value + drift + noise, 0.1, 0.9);
                const x = (i / (SPARKLINE_POINTS - 1)) * SPARKLINE_WIDTH;
                const y = (1 - value) * SPARKLINE_HEIGHT;
                points.push({ x, y });
            }

            return points;
        }

        function createSparklineSvg(points, color) {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', `0 0 ${SPARKLINE_WIDTH} ${SPARKLINE_HEIGHT}`);
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', '100%');
            svg.setAttribute('aria-hidden', 'true');
            svg.setAttribute('focusable', 'false');

            const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            const pointsAttr = points.map((point) => `${point.x},${point.y}`).join(' ');
            polyline.setAttribute('points', pointsAttr);
            polyline.setAttribute('fill', 'none');
            polyline.setAttribute('stroke', color);
            polyline.setAttribute('stroke-width', '2');
            polyline.setAttribute('stroke-linecap', 'round');
            polyline.setAttribute('stroke-linejoin', 'round');

            const last = points[points.length - 1];
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            marker.setAttribute('cx', last.x);
            marker.setAttribute('cy', last.y);
            marker.setAttribute('r', '3');
            marker.setAttribute('fill', color);

            svg.appendChild(polyline);
            svg.appendChild(marker);
            return svg;
        }

        function ensurePlaceholder(card) {
            let placeholder = card.querySelector('.sparkline-placeholder');
            if (!placeholder) {
                placeholder = document.createElement('div');
                placeholder.className = 'sparkline-placeholder';
                placeholder.setAttribute('aria-hidden', 'true');
                card.appendChild(placeholder);
            }
            return placeholder;
        }

        function renderSparklines() {
            const cards = document.querySelectorAll('.market-card');
            cards.forEach((card, index) => {
                const placeholder = ensurePlaceholder(card);
                const changeEl = card.querySelector('.market-change');
                const direction = getChangeDirection(changeEl);
                const symbolKey = getSymbolKey(card, index);
                const seed = hashString(symbolKey);
                const color = SPARKLINE_COLORS[direction];
                const points = buildSparklinePoints(seed, direction);

                placeholder.textContent = '';
                placeholder.appendChild(createSparklineSvg(points, color));
            });
        }

        let renderScheduled = false;
        function scheduleSparklines() {
            if (renderScheduled) return;
            renderScheduled = true;
            requestAnimationFrame(() => {
                renderScheduled = false;
                renderSparklines();
            });
        }

        const marketGrid = document.getElementById('market-grid');
        if (marketGrid && !window.__cryptoSparklineObserver) {
            scheduleSparklines();
            const observer = new MutationObserver(() => scheduleSparklines());
            observer.observe(marketGrid, { childList: true });
            window.__cryptoSparklineObserver = observer;
        }
    </script>
</body>

</html>
